<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Tahoma; 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #333; 
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .header { 
            text-align: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .header h1 { color: #2c3e50; margin-bottom: 10px; }
        .user-info { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
        }
        input:focus { outline: none; border-color: #667eea; }
        .button-group { display: flex; gap: 10px; margin: 20px 0; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            flex: 1;
            transition: all 0.3s;
        }
        .btn-call { background: #4CAF50; color: white; }
        .btn-end { background: #f44336; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn:not(:disabled):hover { transform: translateY(-2px); }
        .status {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin: 15px 0;
        }
        .status-ready { background: #d4edda; color: #155724; }
        .status-calling { background: #fff3cd; color: #856404; }
        .status-connected { background: #d1ecf1; color: #0c5460; }
        .incoming-call {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .call-alert {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 3px solid #4CAF50;
        }
        .alert-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .users-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .user-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }
        .user-item:hover { background: #667eea; color: white; }
        audio { width: 100%; margin: 15px 0; }
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .button-group { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±</h1>
            <div class="user-info">
                <span>Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§:</span>
                <strong id="userId">...</strong>
                <button id="copyId" class="btn btn-secondary">ğŸ“‹ Ú©Ù¾ÛŒ</button>
            </div>
        </div>

        <div class="input-group">
            <label for="callerName">Ù†Ø§Ù… Ø´Ù…Ø§:</label>
            <input type="text" id="callerName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ" value="Ú©Ø§Ø±Ø¨Ø±">
        </div>
        
        <div class="input-group">
            <label for="targetUser">Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø§Ø¨Ù„:</label>
            <input type="text" id="targetUser" placeholder="Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>

        <div class="button-group">
            <button id="startCall" class="btn btn-call">ğŸ“ Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³</button>
            <button id="endCall" class="btn btn-end" disabled>âŒ Ù¾Ø§ÛŒØ§Ù† ØªÙ…Ø§Ø³</button>
        </div>

        <div id="callStatus" class="status status-ready">
            ğŸŸ¢ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ø³
        </div>

        <div id="onlineUsersSection" style="display: none;">
            <h3>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†:</h3>
            <div id="onlineUsers" class="users-list"></div>
        </div>

        <audio id="remoteAudio" autoplay controls style="display: none;"></audio>
    </div>

    <div id="incomingCall" class="incoming-call">
        <div class="call-alert">
            <h3>ğŸ“ ØªÙ…Ø§Ø³ Ø¯Ø±ÛŒØ§ÙØªÛŒ</h3>
            <p id="callerInfo">Ø§Ø²: </p>
            <div class="alert-buttons">
                <button id="acceptCall" class="btn btn-success">âœ… Ù¾Ø°ÛŒØ±Ø´</button>
                <button id="rejectCall" class="btn btn-danger">âŒ Ø±Ø¯</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class VoiceChat {
            constructor() {
                this.socket = io();
                this.localStream = null;
                this.remoteStream = null;
                this.peerConnection = null;
                this.currentCall = null;
                this.isInCall = false;
                
                this.init();
            }

            init() {
                this.initElements();
                this.initSocket();
                this.requestMicrophone();
            }

            initElements() {
                this.userIdElement = document.getElementById('userId');
                this.targetUserInput = document.getElementById('targetUser');
                this.callerNameInput = document.getElementById('callerName');
                this.startCallButton = document.getElementById('startCall');
                this.endCallButton = document.getElementById('endCall');
                this.copyIdButton = document.getElementById('copyId');
                this.callStatusElement = document.getElementById('callStatus');
                this.onlineUsersList = document.getElementById('onlineUsers');
                this.onlineUsersSection = document.getElementById('onlineUsersSection');
                this.incomingCallElement = document.getElementById('incomingCall');
                this.acceptCallButton = document.getElementById('acceptCall');
                this.rejectCallButton = document.getElementById('rejectCall');
                this.remoteAudio = document.getElementById('remoteAudio');
                this.callerInfoElement = document.getElementById('callerInfo');

                this.startCallButton.addEventListener('click', () => this.startCall());
                this.endCallButton.addEventListener('click', () => this.endCall());
                this.copyIdButton.addEventListener('click', () => this.copyUserId());
                this.acceptCallButton.addEventListener('click', () => this.acceptCall());
                this.rejectCallButton.addEventListener('click', () => this.rejectCall());
            }

            initSocket() {
                this.socket.on('user-connected', (data) => {
                    this.userId = data.userId;
                    this.userIdElement.textContent = this.userId;
                    this.updateOnlineUsers(data.onlineUsers);
                });

                this.socket.on('user-joined', (userId) => {
                    this.addOnlineUser(userId);
                });

                this.socket.on('user-left', (userId) => {
                    this.removeOnlineUser(userId);
                });

                this.socket.on('incoming-call', (data) => {
                    this.showIncomingCall(data);
                });

                this.socket.on('call-accepted', (data) => {
                    this.handleCallAccepted(data);
                });

                this.socket.on('call-rejected', (data) => {
                    alert('âŒ Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø§Ø¨Ù„ ØªÙ…Ø§Ø³ Ø±Ø§ Ø±Ø¯ Ú©Ø±Ø¯');
                    this.resetCallUI();
                });

                this.socket.on('call-ended', (data) => {
                    this.handleCallEnded(data);
                });

                this.socket.on('ice-candidate', (data) => {
                    this.handleIceCandidate(data);
                });
            }

            async requestMicrophone() {
                try {
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            channelCount: 1,
                            sampleRate: 44100,
                            sampleSize: 16
                        },
                        video: false
                    });
                    console.log('âœ… Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ÙØ¹Ø§Ù„ Ø´Ø¯');
                    this.updateStatus('ğŸŸ¢ Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ø³', 'ready');
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†:', error);
                    this.updateStatus('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯', 'ready');
                    alert('Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§å…è®¸ Ú©Ù†ÛŒØ¯. Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ø³ ØµÙˆØªÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª.');
                }
            }

            createPeerConnection() {
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                };

                this.peerConnection = new RTCPeerConnection(configuration);

                this.localStream.getTracks().forEach(track => {
                    this.peerConnection.addTrack(track, this.localStream);
                });

                this.peerConnection.ontrack = (event) => {
                    console.log('ğŸµ Ø¯Ø±ÛŒØ§ÙØª ØµØ¯Ø§ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø§Ø¨Ù„');
                    this.remoteStream = event.streams[0];
                    this.remoteAudio.srcObject = this.remoteStream;
                    this.remoteAudio.style.display = 'block';
                };

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate && this.currentCall) {
                        this.socket.emit('ice-candidate', {
                            targetUser: this.currentCall,
                            candidate: event.candidate
                        });
                    }
                };

                this.peerConnection.onconnectionstatechange = () => {
                    const state = this.peerConnection.connectionState;
                    console.log('ğŸ”— ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„:', state);
                    
                    switch (state) {
                        case 'connected':
                            this.updateStatus('âœ… ØªÙ…Ø§Ø³ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ - Ø­Ø§Ù„Ø§ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯', 'connected');
                            this.isInCall = true;
                            break;
                        case 'disconnected':
                        case 'failed':
                            this.updateStatus('âŒ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯', 'ready');
                            this.cleanupCall();
                            break;
                    }
                };
            }

            async startCall() {
                const targetUser = this.targetUserInput.value.trim();
                const callerName = this.callerNameInput.value.trim() || 'Ú©Ø§Ø±Ø¨Ø±';

                if (!targetUser) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }

                if (!this.localStream) {
                    alert('Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§å…è®¸ Ú©Ù†ÛŒØ¯.');
                    return;
                }

                this.currentCall = targetUser;
                this.createPeerConnection();

                try {
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);

                    this.socket.emit('start-call', {
                        targetUser: targetUser,
                        offer: offer,
                        callerName: callerName
                    });

                    this.updateStatus('ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ ØªÙ…Ø§Ø³...', 'calling');
                    this.startCallButton.disabled = true;
                    this.endCallButton.disabled = false;

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ø³:', error);
                    this.cleanupCall();
                }
            }

            showIncomingCall(data) {
                this.callerInfoElement.textContent = `Ø§Ø²: ${data.callerName} (${data.from})`;
                this.currentCall = data.from;
                this.pendingOffer = data.offer;
                this.incomingCallElement.style.display = 'flex';
            }

            async acceptCall() {
                if (!this.pendingOffer || !this.localStream) return;

                this.createPeerConnection();
                
                try {
                    await this.peerConnection.setRemoteDescription(this.pendingOffer);
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                    this.socket.emit('accept-call', {
                        targetUser: this.currentCall,
                        answer: answer
                    });

                    this.updateStatus('ğŸ§ Ø¯Ø± Ø­Ø§Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡...', 'connected');
                    this.startCallButton.disabled = true;
                    this.endCallButton.disabled = false;
                    this.incomingCallElement.style.display = 'none';
                    this.isInCall = true;

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø°ÛŒØ±Ø´ ØªÙ…Ø§Ø³:', error);
                    this.cleanupCall();
                }
            }

            rejectCall() {
                this.socket.emit('reject-call', { targetUser: this.currentCall });
                this.incomingCallElement.style.display = 'none';
                this.cleanupCall();
            }

            async handleCallAccepted(data) {
                if (!this.peerConnection) return;

                try {
                    await this.peerConnection.setRemoteDescription(data.answer);
                    this.updateStatus('ğŸ§ Ø¯Ø± Ø­Ø§Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡...', 'connected');
                    this.isInCall = true;
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„:', error);
                    this.cleanupCall();
                }
            }

            async handleIceCandidate(data) {
                if (this.peerConnection && data.candidate) {
                    try {
                        await this.peerConnection.addIceCandidate(data.candidate);
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ICE candidate:', error);
                    }
                }
            }

            handleCallEnded(data) {
                this.updateStatus('ğŸ“ ØªÙ…Ø§Ø³ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª', 'ready');
                this.cleanupCall();
            }

            endCall() {
                if (this.currentCall) {
                    this.socket.emit('end-call', { targetUser: this.currentCall });
                }
                this.updateStatus('ğŸ“ ØªÙ…Ø§Ø³ Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª', 'ready');
                this.cleanupCall();
            }

            cleanupCall() {
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                if (this.remoteAudio.srcObject) {
                    this.remoteAudio.srcObject = null;
                    this.remoteAudio.style.display = 'none';
                }

                this.currentCall = null;
                this.isInCall = false;
                this.pendingOffer = null;
                
                this.startCallButton.disabled = false;
                this.endCallButton.disabled = true;
                this.incomingCallElement.style.display = 'none';
            }

            updateStatus(message, type) {
                this.callStatusElement.textContent = message;
                this.callStatusElement.className = `status status-${type}`;
            }

            copyUserId() {
                if (!this.userId) return;
                
                navigator.clipboard.writeText(this.userId)
                    .then(() => alert(`Ø´Ù†Ø§Ø³Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯: ${this.userId}`))
                    .catch(() => {
                        // Fallback Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
                        const tempInput = document.createElement('input');
                        tempInput.value = this.userId;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        alert(`Ø´Ù†Ø§Ø³Ù‡ Ú©Ù¾ÛŒ Ø´Ø¯: ${this.userId}`);
                    });
            }

            updateOnlineUsers(users) {
                this.onlineUsersList.innerHTML = '';
                
                if (users.length === 0) {
                    this.onlineUsersList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                    return;
                }

                this.onlineUsersSection.style.display = 'block';
                users.forEach(userId => {
                    this.addOnlineUser(userId);
                });
            }

            addOnlineUser(userId) {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.innerHTML = `ğŸ‘¤ ${userId}`;
                userElement.onclick = () => {
                    this.targetUserInput.value = userId;
                };
                this.onlineUsersList.appendChild(userElement);
            }

            removeOnlineUser(userId) {
                const userElements = this.onlineUsersList.getElementsByClassName('user-item');
                for (let element of userElements) {
                    if (element.textContent.includes(userId)) {
                        element.remove();
                        break;
                    }
                }
                
                if (this.onlineUsersList.children.length === 0) {
                    this.onlineUsersSection.style.display = 'none';
                }
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceChat();
        });
    </script>
</body>
</html>
